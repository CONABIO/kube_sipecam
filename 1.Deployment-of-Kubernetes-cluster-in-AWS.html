
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Kubernetes &#8212; kube sipecam 0.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Welcome to kube sipecam’s documentation!" href="index.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <a class="reference internal image-reference" href="_images/KUBE_SIPECAM_AWS.png"><img alt="_images/KUBE_SIPECAM_AWS.png" src="_images/KUBE_SIPECAM_AWS.png" style="width: 400px;" /></a>
<section id="kubernetes">
<h1>Kubernetes<a class="headerlink" href="#kubernetes" title="Permalink to this headline">¶</a></h1>
<p>Kubernetes is an open-source system for automating deployment, scaling, and management of containerized applications (see <a class="reference external" href="https://kubernetes.io/">Kubernetes</a> and <a class="reference external" href="https://github.com/kubernetes/kubernetes">Kubernetes github page</a> ).</p>
<section id="cluster-creation">
<h2>Cluster creation<a class="headerlink" href="#cluster-creation" title="Permalink to this headline">¶</a></h2>
<p>The nex steps follow <a class="reference external" href="https://kubernetes.io/docs/setup/custom-cloud/kops/">kops</a> and <a class="reference external" href="https://github.com/kubernetes/kops">kops - Kubernetes Operations</a> guides (another guide: <a class="reference external" href="https://zero-to-jupyterhub.readthedocs.io/en/latest/amazon/step-zero-aws.html">Step Zero Kubernetes on AWS</a>).</p>
<ol class="arabic simple">
<li><p>Configure a domain and a subdomain with their respective hosted zones. For the following description <a class="reference external" href="https://aws.amazon.com/route53/?nc1=h_ls">Route 53</a> service of AWS was used to create domain <code class="docutils literal notranslate"><span class="pre">conabio-route53.net</span></code> and subdomain <code class="docutils literal notranslate"><span class="pre">antares3.conabio-route53.net</span></code>. Also a <strong>gossip based Kubernetes cluster</strong> can be used instead (see for example this <a class="reference external" href="https://github.com/kubernetes/kops/issues/2858">issue</a> ).</p></li>
<li><p>Install <strong>same versions</strong> of kops and kubectl. You can use a <code class="docutils literal notranslate"><span class="pre">t2.micro</span></code> ec2 instance with AMI <code class="docutils literal notranslate"><span class="pre">Ubuntu</span> <span class="pre">18.04</span> <span class="pre">LTS</span></code> and a role attached to it with <code class="docutils literal notranslate"><span class="pre">AmazonEc2FullAccess</span></code> to install this tools and label it with the next bash script:</p></li>
</ol>
<p><strong>Note: change region in next bash script where you deployed t2.micro instance</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">##variables:</span>
<span class="nv">region</span><span class="o">=</span>&lt;region&gt;
<span class="nv">name_instance</span><span class="o">=</span>conabio-kubernetes
<span class="nv">shared_volume</span><span class="o">=</span>/shared_volume
<span class="nv">user</span><span class="o">=</span>ubuntu
<span class="c1">##System update</span>
<span class="nb">export</span> <span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive
apt-get update -yq
<span class="c1">##Install awscli</span>
apt-get install -y python3-pip <span class="o">&amp;&amp;</span> pip3 install --upgrade pip
pip3 install awscli --upgrade
<span class="c1">##Tag instance</span>
<span class="nv">INSTANCE_ID</span><span class="o">=</span><span class="k">$(</span>curl -s http://instance-data/latest/meta-data/instance-id<span class="k">)</span>
<span class="nv">PUBLIC_IP</span><span class="o">=</span><span class="k">$(</span>curl -s http://instance-data/latest/meta-data/public-ipv4<span class="k">)</span>
aws ec2 create-tags --resources <span class="nv">$INSTANCE_ID</span> --tag <span class="nv">Key</span><span class="o">=</span>Name,Value<span class="o">=</span><span class="nv">$name_instance</span>-<span class="nv">$PUBLIC_IP</span> --region<span class="o">=</span><span class="nv">$region</span>
<span class="c1">##Set variables for completion of bash commands</span>
<span class="nb">echo</span> <span class="s2">&quot;export LC_ALL=C.UTF-8&quot;</span> &gt;&gt; /home/<span class="nv">$user</span>/.profile
<span class="nb">echo</span> <span class="s2">&quot;export LANG=C.UTF-8&quot;</span> &gt;&gt; /home/<span class="nv">$user</span>/.profile
<span class="c1">##Set variable mount_point</span>
<span class="nb">echo</span> <span class="s2">&quot;export mount_point=</span><span class="nv">$shared_volume</span><span class="s2">&quot;</span> &gt;&gt; /home/<span class="nv">$user</span>/.profile
<span class="c1">##Useful software for common operations</span>
apt-get install -y nfs-common jq git htop nano
<span class="c1">##Create shared volume</span>
mkdir <span class="nv">$shared_volume</span>
<span class="c1">##install docker for ubuntu:</span>
apt-get install -y apt-transport-https ca-certificates curl software-properties-common
curl -fsSL https://download.docker.com/linux/ubuntu/gpg <span class="p">|</span> sudo apt-key add -
add-apt-repository <span class="s2">&quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu </span><span class="k">$(</span>lsb_release -cs<span class="k">)</span><span class="s2"> stable&quot;</span>
apt-get update -yq
apt-get install -y docker-ce
service docker start
<span class="c1">##install kops version 1.14.0:</span>
wget -O kops https://github.com/kubernetes/kops/releases/download/1.14.0/kops-linux-amd64
chmod +x ./kops
sudo mv ./kops /usr/local/bin/
<span class="c1">##install kubernetes command line tool v1.14: kubectl</span>
wget -O kubectl https://storage.googleapis.com/kubernetes-release/release/v1.14.0/bin/linux/amd64/kubectl
chmod +x ./kubectl
sudo mv ./kubectl /usr/local/bin/kubectl
<span class="c1">##enable completion for kubectl:</span>
<span class="nb">echo</span> <span class="s2">&quot;source &lt;(kubectl completion bash)&quot;</span> &gt;&gt; /home/<span class="nv">$user</span>/.bashrc
</pre></div>
</div>
<p>You can check kops and kubectl versions with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$kops</span> version

<span class="nv">$kubectl</span> version
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All <code class="docutils literal notranslate"><span class="pre">kubectl</span></code> and <code class="docutils literal notranslate"><span class="pre">kops</span></code> commands must be executed in this instance.</p>
</div>
<ol class="arabic simple" start="3">
<li><p>Set next bash variables:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">#Your domain name that is hosted in AWS Route 53</span>
<span class="c1">#Use: export DOMAIN_NAME=&quot;antares3.k8s.local&quot; #for a gossip based cluster</span>
<span class="nb">export</span> <span class="nv">DOMAIN_NAME</span><span class="o">=</span><span class="s2">&quot;antares3.conabio-route53.net&quot;</span>

<span class="c1"># Friendly name to use as an alias for your cluster</span>
<span class="nb">export</span> <span class="nv">CLUSTER_ALIAS</span><span class="o">=</span><span class="s2">&quot;k8s-deployment&quot;</span>

<span class="c1"># Leave as-is: Full DNS name of you cluster</span>
<span class="nb">export</span> <span class="nv">CLUSTER_FULL_NAME</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CLUSTER_ALIAS</span><span class="si">}</span><span class="s2">.</span><span class="si">${</span><span class="nv">DOMAIN_NAME</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="c1"># AWS availability zone where the cluster will be created</span>
<span class="nb">export</span> <span class="nv">CLUSTER_AWS_AZ</span><span class="o">=</span>us-west-2a,us-west-2b,us-west-2c

<span class="c1"># Leave as-is: AWS Route 53 hosted zone ID for your domain (don&#39;t set it if gossip based cluster is used)</span>
<span class="nb">export</span> <span class="nv">DOMAIN_NAME_ZONE_ID</span><span class="o">=</span><span class="k">$(</span>aws route53 list-hosted-zones <span class="se">\</span>
       <span class="p">|</span> jq -r <span class="s1">&#39;.HostedZones[] | select(.Name==&quot;&#39;</span><span class="si">${</span><span class="nv">DOMAIN_NAME</span><span class="si">}</span><span class="s1">&#39;.&quot;) | .Id&#39;</span> <span class="se">\</span>
       <span class="p">|</span> sed <span class="s1">&#39;s/\/hostedzone\///&#39;</span><span class="k">)</span>

<span class="nb">export</span> <span class="nv">KUBERNETES_VERSION</span><span class="o">=</span><span class="s2">&quot;1.14.0&quot;</span>

<span class="c1">#To hold cluster state information export KOPS_STATE_STORE</span>
<span class="nb">export</span> <span class="nv">KOPS_STATE_STORE</span><span class="o">=</span><span class="s2">&quot;s3://</span><span class="si">${</span><span class="nv">CLUSTER_FULL_NAME</span><span class="si">}</span><span class="s2">-state&quot;</span>

<span class="nb">export</span> <span class="nv">EDITOR</span><span class="o">=</span>nano
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Create AWS S3 bucket to hold information for Kubernetes cluster:</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The instance needs the policy <strong>AmazonS3FullAccess</strong> attach to a role created by you to have permissions to execute next command.</p>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">#Bucket will be created in us-east (N. Virginia)</span>
<span class="nv">$aws</span> s3api create-bucket --bucket <span class="si">${</span><span class="nv">CLUSTER_FULL_NAME</span><span class="si">}</span>-state
</pre></div>
</div>
<ol class="arabic simple" start="5">
<li><p>Create group and user kops and generate access keys for user kops:</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The instance needs the policy <strong>IAMFullAccess</strong> attach to a role created by you to have permissions to execute next command.</p>
</div>
<p>Create group and permissions of it:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$name</span><span class="o">=</span>kops

<span class="nv">$aws</span> iam create-group --group-name <span class="nv">$name</span>

<span class="nv">$aws</span> iam attach-group-policy --policy-arn arn:aws:iam::aws:policy/AmazonEC2FullAccess --group-name <span class="nv">$name</span>

<span class="nv">$aws</span> iam attach-group-policy --policy-arn arn:aws:iam::aws:policy/AmazonRoute53FullAccess --group-name <span class="nv">$name</span>

<span class="nv">$aws</span> iam attach-group-policy --policy-arn arn:aws:iam::aws:policy/AmazonS3FullAccess --group-name <span class="nv">$name</span>

<span class="nv">$aws</span> iam attach-group-policy --policy-arn arn:aws:iam::aws:policy/IAMFullAccess --group-name <span class="nv">$name</span>

<span class="nv">$aws</span> iam attach-group-policy --policy-arn arn:aws:iam::aws:policy/AmazonVPCFullAccess --group-name <span class="nv">$name</span>

<span class="nv">$aws</span> iam attach-group-policy --policy-arn arn:aws:iam::aws:policy/AmazonElasticFileSystemFullAccess --group-name <span class="nv">$name</span>
</pre></div>
</div>
<p>Create user kops and add it to already created group kops:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$aws</span> iam create-user --user-name <span class="nv">$name</span>

<span class="nv">$aws</span> iam add-user-to-group --user-name <span class="nv">$name</span> --group-name <span class="nv">$name</span>
</pre></div>
</div>
<p>Create access keys for user kops:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$aws</span> iam create-access-key --user-name <span class="nv">$name</span>
</pre></div>
</div>
<p>This will generate an <strong>AccessKeyId</strong> and <strong>SecretAccessKey</strong> that must be kept in a safe place. Use them to configure awscli and set next variables:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$aws</span> configure
        AWS Access Key ID <span class="o">[</span>None<span class="o">]</span>: xxxx
        AWS Secret Access Key <span class="o">[</span>None<span class="o">]</span>: xxxxxxx
        Default region name <span class="o">[</span>None<span class="o">]</span>: &lt;leave it empty&gt;
        Default output format <span class="o">[</span>None<span class="o">]</span>: &lt;leave it empty&gt;

<span class="nv">$export</span> <span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="k">$(</span>aws configure get aws_access_key_id<span class="k">)</span>

<span class="nv">$export</span> <span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="k">$(</span>aws configure get aws_secret_access_key<span class="k">)</span>
</pre></div>
</div>
<ol class="arabic simple" start="6">
<li><p>Create a Key Pair with AWS console and a Public Key. See <a class="reference external" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html">Amazon EC2 Key Pairs</a> sections: <strong>Creating a Key Pair Using Amazon EC2</strong> and <strong>Creating a Key Pair Using Amazon EC2</strong>. Save the Public Key in <code class="docutils literal notranslate"><span class="pre">/home/ubuntu/.ssh/id_rsa.pub</span></code>.</p></li>
<li><p>Deploy Kubernetes Cluster. An example is:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$kops</span> create cluster <span class="se">\</span>
--name<span class="o">=</span><span class="si">${</span><span class="nv">CLUSTER_FULL_NAME</span><span class="si">}</span> <span class="se">\</span>
--zones<span class="o">=</span><span class="si">${</span><span class="nv">CLUSTER_AWS_AZ</span><span class="si">}</span> <span class="se">\</span>
--master-size<span class="o">=</span><span class="s2">&quot;t2.medium&quot;</span> <span class="se">\</span>
--node-size<span class="o">=</span><span class="s2">&quot;t2.medium&quot;</span> <span class="se">\</span>
--node-count<span class="o">=</span><span class="s2">&quot;1&quot;</span> <span class="se">\</span>
--dns-zone<span class="o">=</span><span class="si">${</span><span class="nv">DOMAIN_NAME</span><span class="si">}</span> <span class="se">\</span>
--ssh-public-key<span class="o">=</span><span class="s2">&quot;/home/ubuntu/.ssh/id_rsa.pub&quot;</span> <span class="se">\</span>
--kubernetes-version<span class="o">=</span><span class="si">${</span><span class="nv">KUBERNETES_VERSION</span><span class="si">}</span>

<span class="nv">$kops</span> update cluster --name <span class="si">${</span><span class="nv">CLUSTER_FULL_NAME</span><span class="si">}</span> --yes
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Check status of cluster with <code class="docutils literal notranslate"><span class="pre">kops</span> <span class="pre">validate</span> <span class="pre">cluster</span></code> and wait until it says <strong>Your cluster $CLUSTER_FULL_NAME is ready</strong></p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can delete cluster with: <code class="docutils literal notranslate"><span class="pre">$kops</span> <span class="pre">delete</span> <span class="pre">cluster</span> <span class="pre">${CLUSTER_FULL_NAME}</span></code> and then <code class="docutils literal notranslate"><span class="pre">$kops</span> <span class="pre">delete</span> <span class="pre">cluster</span> <span class="pre">${CLUSTER_FULL_NAME}</span> <span class="pre">--yes</span></code> (without <code class="docutils literal notranslate"><span class="pre">yes</span></code> flag you only see what changes are going to be applied) and don’t forget to delete S3 bucket: <code class="docutils literal notranslate"><span class="pre">$aws</span> <span class="pre">s3api</span> <span class="pre">delete-bucket</span> <span class="pre">--bucket</span> <span class="pre">${CLUSTER_FULL_NAME}-state</span></code> after cluster deletion.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can scale up/down nodes of cluster with command: <code class="docutils literal notranslate"><span class="pre">$kops</span> <span class="pre">edit</span> <span class="pre">ig</span> <span class="pre">nodes</span> <span class="pre">--name</span> <span class="pre">$CLUSTER_FULL_NAME</span></code>, edit screen that appears and set 3/0 number of instances in minSize, maxSize values (3 is an example) and then <code class="docutils literal notranslate"><span class="pre">$kops</span> <span class="pre">update</span> <span class="pre">cluster</span> <span class="pre">$CLUSTER_FULL_NAME</span></code> and  <code class="docutils literal notranslate"><span class="pre">$kops</span> <span class="pre">update</span> <span class="pre">cluster</span> <span class="pre">$CLUSTER_FULL_NAME</span> <span class="pre">--yes</span></code> to apply changes. Command <code class="docutils literal notranslate"><span class="pre">kops</span> <span class="pre">validate</span> <span class="pre">cluster</span></code> is useful to see state of cluster.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To scale up/down master you can use: <code class="docutils literal notranslate"><span class="pre">$kops</span> <span class="pre">edit</span> <span class="pre">ig</span> <span class="pre">master-us-west-2a</span> <span class="pre">--name</span> <span class="pre">$CLUSTER_FULL_NAME</span></code> (you can check your instance type of master with: <code class="docutils literal notranslate"><span class="pre">$kops</span> <span class="pre">get</span> <span class="pre">instancegroups</span></code>) set 1/0 number of instances in minSize, maxSize values and then <code class="docutils literal notranslate"><span class="pre">$kops</span> <span class="pre">update</span> <span class="pre">cluster</span> <span class="pre">$CLUSTER_FULL_NAME</span></code> and <code class="docutils literal notranslate"><span class="pre">$kops</span> <span class="pre">update</span> <span class="pre">cluster</span> <span class="pre">$CLUSTER_FULL_NAME</span> <span class="pre">--yes</span></code> to apply changes. Command <code class="docutils literal notranslate"><span class="pre">kops</span> <span class="pre">validate</span> <span class="pre">cluster</span></code> is useful to see state of cluster.</p>
</div>
<p><strong>¿How do I ssh to an instance of Kubernetes Cluster?</strong></p>
<p>Using the key-pem already created for the kops user execute:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$ssh</span> -i &lt;key&gt;.pem admin@api.<span class="nv">$CLUSTER_FULL_NAME</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Make sure this &lt;key&gt;.pem has 400 permissions: <code class="docutils literal notranslate"><span class="pre">$chmod</span> <span class="pre">400</span> <span class="pre">&lt;key&gt;.pem</span></code>.</p>
</div>
<p>You can also deploy kubernetes dashboard for your cluster.</p>
</section>
<section id="kubernetes-dashboard">
<h2>Kubernetes dashboard<a class="headerlink" href="#kubernetes-dashboard" title="Permalink to this headline">¶</a></h2>
<p>According to <a class="reference external" href="https://github.com/kubernetes/dashboard">Kubernetes Dashboard</a> kubernetes dashboard is a general purpose, web-based UI for kubernetes clusters. It allows users to manage applications running in the cluster and troubleshoot them, as well as manage the cluster itself.</p>
<p>Next steps are based on: <a class="reference external" href="https://github.com/kubernetes/dashboard/blob/master/docs/user/certificate-management.md">Certificate management</a>, <a class="reference external" href="https://github.com/kubernetes/dashboard/blob/master/docs/user/installation.md">Installation</a>, <a class="reference external" href="https://github.com/kubernetes/dashboard/blob/master/docs/user/accessing-dashboard/1.7.x-and-above.md">Accessing Dashboard 1.7.X and above</a> and <a class="reference external" href="https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md">Creating sample user</a> from kubernetes official documentation and installation of <a class="reference external" href="https://certbot.eff.org/lets-encrypt/ubuntubionic-other">Certbot for Ubuntu (18.04) bionic</a> and <a class="reference external" href="https://certbot-dns-route53.readthedocs.io/en/latest/#">certbot-dns-route53</a> to generate certificates and access kubernetes dashboard via https.</p>
<p>Install certbot and Route53 plugin for Let’s Encrypt client:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$sudo</span> apt-get update
<span class="nv">$sudo</span> apt-get install -y software-properties-common
<span class="nv">$sudo</span> add-apt-repository universe
<span class="nv">$sudo</span> add-apt-repository ppa:certbot/certbot
<span class="nv">$sudo</span> apt-get update
<span class="nv">$sudo</span> apt-get install -y certbot
<span class="c1">#check version of certbot and install route53 plugin:</span>
<span class="nv">certbot_v</span><span class="o">=</span><span class="k">$(</span>certbot --version<span class="p">|</span>cut -d<span class="s1">&#39; &#39;</span> -f2<span class="k">)</span>
<span class="nv">$sudo</span> pip3 install <span class="nv">certbot_dns_route53</span><span class="o">==</span><span class="nv">$certbot_v</span>
</pre></div>
</div>
<p>Create some useful directories:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$mkdir</span> -p ~/letsencrypt/log/
<span class="nv">$mkdir</span> -p ~/letsencrypt/config/
<span class="nv">$mkdir</span> -p ~/letsencrypt/work/
</pre></div>
</div>
<p>Using <code class="docutils literal notranslate"><span class="pre">kubectl</span></code> retrieve where is kubernetes master running:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl cluster-info
Kubernetes master is running at &lt;location&gt;
KubeDNS is running at &lt;location&gt;/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use <span class="s1">&#39;kubectl cluster-info dump&#39;</span>.
</pre></div>
</div>
<p>Generate certificate for the &lt;location&gt; (remove https if it’s the case, just the dns name) of last command (make sure to save directory letsencrypt in a safe place):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$certbot</span> certonly -d &lt;location&gt; --dns-route53 --logs-dir letsencrypt/log/ --config-dir letsencrypt/config/ --work-dir letsencrypt/work/ -m myemail@myinstitution --agree-tos --non-interactive --dns-route53-propagation-seconds <span class="m">20</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Make sure you save the date that will expire your certificate. To renew certificate execute:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$certbot</span> renew --dns-route53 --logs-dir letsencrypt/log/ <span class="se">\</span>
 --config-dir letsencrypt/config/ --work-dir letsencrypt/work/ <span class="se">\</span>
 --non-interactive
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Also you need to have some symlinks created under directory: <code class="docutils literal notranslate"><span class="pre">letsencrypt/config/live/&lt;location&gt;</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cert.pem -&gt; ../../archive/&lt;location&gt;/cert1.pem
chain.pem -&gt; ../../archive/&lt;location&gt;/chain1.pem
fullchain.pem -&gt; ../../archive/&lt;location&gt;/fullchain1.pem
privkey.pem -&gt; ../../archive/&lt;location&gt;/privkey1.pem
</pre></div>
</div>
</div>
<p>Create directory <code class="docutils literal notranslate"><span class="pre">certs</span></code> and copy cert and private key:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$mkdir</span> certs
<span class="nv">$cp</span> letsencrypt/config/archive/&lt;location&gt;/fullchain1.pem certs/
<span class="nv">$cp</span> letsencrypt/config/archive/&lt;location&gt;/privkey1.pem certs/
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When renewing your certificate the latest ones will be symlinks located: <code class="docutils literal notranslate"><span class="pre">letsencrypt/config/live/&lt;location&gt;/</span></code>. See <a class="reference external" href="https://certbot.eff.org/docs/using.html#where-are-my-certificates">Where are my certificates?</a></p>
</div>
<p>Retrieve <cite>yaml</cite> to deploy kubernetes dashboard and change some values:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$curl</span> -O https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-rc5/aio/deploy/recommended.yaml
<span class="nv">$sed</span> -ni <span class="s1">&#39;s/- --auto-generate-certificates/#- --auto-generate-certificates/;p&#39;</span> recommended.yaml
<span class="nv">$sed</span> -i <span class="s1">&#39;/args:/a \ \ \ \ \ \ \ \ \ \ \ \ - --tls-cert-file=fullchain1.pem&#39;</span> recommended.yaml
<span class="nv">$sed</span> -i <span class="s1">&#39;/args:/a \ \ \ \ \ \ \ \ \ \ \ \ - --tls-key-file=privkey1.pem&#39;</span> recommended.yaml
</pre></div>
</div>
<p>Create deployments and services with <code class="docutils literal notranslate"><span class="pre">kubernetes-dashboard.yaml</span></code> :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$kubectl</span> apply -f recommended.yaml
</pre></div>
</div>
<p>Delete <cite>certs</cite> and recreate secrets using the <cite>.pem</cite> that we created with <cite>certbot</cite>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$kubectl</span> delete secret kubernetes-dashboard-certs -n kubernetes-dashboard
<span class="nv">$kubectl</span> create secret generic kubernetes-dashboard-certs --from-file<span class="o">=</span>certs -n kubernetes-dashboard
</pre></div>
</div>
<p>You can check that containers are running by executing:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$kubectl</span> -n kubernetes-dashboard get pods
</pre></div>
</div>
<p>To visualize kubernetes-dashboard one possibility is to change type <code class="docutils literal notranslate"><span class="pre">ClusterIP</span></code> to <code class="docutils literal notranslate"><span class="pre">NodePort</span></code> (see <a class="reference external" href="https://github.com/kubernetes/dashboard/blob/master/docs/user/accessing-dashboard/1.7.x-and-above.md">Accessing Dashboard 1.7.X and above</a>) when executing next command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$kubectl</span> edit service kubernetes-dashboard -n kubernetes-dashboard
</pre></div>
</div>
<p>and get port with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$kubectl</span> get service kubernetes-dashboard -n kubernetes-dashboard
</pre></div>
</div>
<p>Open port retrieved by last command in masters security group of kubernetes cluster with aws console. In your browser type:</p>
<p><code class="docutils literal notranslate"><span class="pre">https://&lt;location&gt;:&lt;port&gt;</span></code></p>
<p>Documentation of <a class="reference external" href="https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md">Creating sample user</a> can be used to access via token generation. Use:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl -n kubernetes-dashboard describe secret <span class="k">$(</span>kubectl -n kubernetes-dashboard get secret <span class="p">|</span> grep admin-user <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span>
</pre></div>
</div>
<p>to retrieve token.</p>
<a class="reference internal image-reference" href="_images/k8s-dashboard-1.png"><img alt="_images/k8s-dashboard-1.png" src="_images/k8s-dashboard-1.png" style="width: 400px;" /></a>
<a class="reference internal image-reference" href="_images/k8s-dashboard-2.png"><img alt="_images/k8s-dashboard-2.png" src="_images/k8s-dashboard-2.png" style="width: 400px;" /></a>
<p>To scale down components of kubernetes dashboard:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$kubectl</span> -n kubernetes-dashboard scale deployments/dashboard-metrics-scraper --replicas<span class="o">=</span><span class="m">0</span>
<span class="nv">$kubectl</span> -n kubernetes-dashboard scale deployments/kubernetes-dashboard --replicas<span class="o">=</span><span class="m">0</span>
</pre></div>
</div>
<p>To scale up components of kubernetes dashboard:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$kubectl</span> -n kubernetes-dashboard scale deployments/dashboard-metrics-scraper --replicas<span class="o">=</span><span class="m">1</span>
<span class="nv">$kubectl</span> -n kubernetes-dashboard scale deployments/kubernetes-dashboard --replicas<span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
<p>To delete components of kubernetes dashboard:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">#delete admin-user created:</span>

<span class="nv">$kubectl</span> -n kubernetes-dashboard delete serviceaccount admin-user
<span class="nv">$kubectl</span> -n kubernetes-dashboard delete ClusterRoleBinding admin-user

<span class="c1">#delete dashboard components:</span>
<span class="nv">$kubectl</span> delete deployment kubernetes-metrics-scraper -n kubernetes-dashboard
<span class="nv">$kubectl</span> delete deployment kubernetes-dashboard -n kubernetes-dashboard
<span class="nv">$kubectl</span> delete service dashboard-metrics-scraper -n kubernetes-dashboard
<span class="nv">$kubectl</span> delete clusterrolebinding kubernetes-dashboard -n kubernetes-dashboard
<span class="nv">$kubectl</span> delete rolebinding kubernetes-dashboard -n kubernetes-dashboard
<span class="nv">$kubectl</span> delete clusterrole kubernetes-dashboard -n kubernetes-dashboard
<span class="nv">$kubectl</span> delete role kubernetes-dashboard -n kubernetes-dashboard
<span class="nv">$kubectl</span> delete configmap kubernetes-dashboard-settings -n kubernetes-dashboard
<span class="nv">$kubectl</span> delete secret kubernetes-dashboard-key-holder -n kubernetes-dashboard
<span class="nv">$kubectl</span> delete secret kubernetes-dashboard-csrf -n kubernetes-dashboard
<span class="nv">$kubectl</span> delete service kubernetes-dashboard -n kubernetes-dashboard
<span class="nv">$kubectl</span> delete serviceaccount kubernetes-dashboard -n kubernetes-dashboard
<span class="nv">$kubectl</span> delete secret kubernetes-dashboard-certs -n kubernetes-dashboard
<span class="nv">$kubectl</span> delete namespace kubernetes-dashboard -n kubernetes-dashboard
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">kube sipecam</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Kubernetes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#cluster-creation">Cluster creation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#kubernetes-dashboard">Kubernetes dashboard</a></li>
</ul>
</li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="index.html" title="previous chapter">Welcome to kube sipecam’s documentation!</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, CONABIO.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.0.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/1.Deployment-of-Kubernetes-cluster-in-AWS.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>